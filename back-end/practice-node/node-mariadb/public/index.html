<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Node - MariaDB</title>
    <link rel="stylesheet" href="./css/common.css" />
  </head>
  <script>
    window.addEventListener("load", (e) => {
      // DOM ì°¾ì•„ì˜¤ê¸°
      let allbtn = document.getElementById("allbtn");
      let content = document.getElementById("content");

      // allbtn í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
      allbtn.addEventListener("click", (e) => {
        // ajaxë¡œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        let request = new XMLHttpRequest();
        // ë·°ë‘ ì„œë²„ê°€ ê°™ì´ ìˆì„ ë•ŒëŠ” ip ë²ˆí˜¸ì™€ í¬íŠ¸ë²ˆí˜¸ëŠ” ìƒëµí•´ë„ ëœë‹¤.
        // ê·¸ë ‡ì§€ë§Œ ë¦¬ì•¡íŠ¸ê°™ì€ê±¸ë¡œ ë”°ë¡œ ê°œë°œí•  ë•ŒëŠ” ëª¨ë‘ ì¨ì¤˜ì•¼ í•¨. (http://127.0.0.1:9000/item/all)
        // ìš”ì²­ ìƒì„±
        request.open("GET", "/item/all");

        // ìš”ì²­
        request.send("");

        // ë°ì´í„°ê°€ ì „ì†¡ëœ ê²½ìš° ì²˜ë¦¬
        request.addEventListener("load", () => {
          // ì¶œë ¥ì„ í•˜ê¸° ìœ„í•´ì„œëŠ” JSON ë¬¸ìì—´ì„ ìë°”ìŠ¤í¬ë¦½íŠ¸ ê°ì²´ë¡œ ë³€í™˜í•´ì•¼ í•¨
          let data = JSON.parse(request.responseText);
          if (data.result == true) {
            let display = "<div align='center' class='body1'>";
            display += "<h2>ìƒí’ˆ ëª©ë¡</h2>";
            display += "<table border='1'>";
            display += "<tr class='header'>";
            display += "<th align='center' width='80'>ID</th>";
            display += "<th align='center' width='320'>ì´ë¦„</th>";
            display += "<th align='center' width='100'>ê°€ê²©</th>";

            // list í‚¤ì— ìˆëŠ” ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê¸°
            let ar = data.list;

            for (let item of ar) {
              display += "<tr class='record'>";

              display += "<td align='center'>" + item.itemid + "</td>";
              display += "<td align='left'>" + item.itemname + "</td>";
              display += "<td align='right'>" + item.price + "</td>";
              display += "</tr>";
            }
            display += "</tr>";
            display == "</table></div>";
            content.innerHTML = display;
          } else {
            content.innerHTML = "ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨";
          }
        });
      });

      let listbtn = document.getElementById("listbtn");
      // í˜„ì¬ í˜ì´ì§€ ë²ˆí˜¸ë¥¼ ì €ì¥í•  ë³€ìˆ˜ë¥¼ ì„ ì–¸
      let pageno = 1;
      listbtn.addEventListener("click", (e) => {
        let request = new XMLHttpRequest();
        request.open("GET", "/item/list?pageno=" + pageno);
        request.send("");
        request.addEventListener("load", () => {
          // ì¶œë ¥ ì˜ì—­ì„ ì´ˆê¸°í™”
          content.innerHTML = "";
          // ë°ì´í„°ë¥¼ íŒŒì‹±
          let data = JSON.parse(request.responseText);
          if (data.result == true) {
            // ë°ì´í„° ê°œìˆ˜ì™€ ëª©ë¡ì„ ê°€ì ¸ì˜¤ê¸°
            let { count, list } = data;

            // ì¶œë ¥ ë‚´ìš© ë§Œë“¤ê¸°
            let display = "<div align='center' class='body'>";
            display += "<h2>ìƒí’ˆ ëª©ë¡</h2>";
            display += "<table border='1' id='tbldata'>";

            // ì „ì²´ ë°ì´í„° ê°œìˆ˜ ì¶œë ¥
            display += "<tr><td colspan='3' align='center'>";
            display += "ì „ì²´ ë°ì´í„° ê°œìˆ˜:" + count + "ê°œ</td></tr>";

            // í•­ëª© í—¤ë” ì¶œë ¥
            display += "<tr class='header'>";
            display += "<th width='80'>ID</th>";
            display += "<th width='320'>ìƒí’ˆëª…</th>";
            display += "<th width='100'>ê°€ê²©</th>";
            display += "</tr>";

            // ë°ì´í„° ëª©ë¡ ì¶œë ¥
            for (item of list) {
              display += "<tr class='record'>";
              display += "<td align='center'>" + item.itemid + "</td>";
              display +=
                "<td align='left'>" +
                "<a href='#' id='item" +
                item.itemid +
                "'>" +
                item.itemname +
                "</a></td>";
              display += "<td align='right'>" + item.price + "ì›</td>";
              display += "</tr>";
            }

            display == "</table></div>";

            // ë”ë³´ê¸° êµ¬í˜„
            // í˜„ì¬ í˜ì´ì§€ê°€ ë§ˆì§€ë§‰ í˜ì´ì§€ê°€ ì•„ë‹Œ ê²½ìš°ë§Œ ì¶œë ¥
            if ((pageno - 1) * 5 < count) {
              display += "<table align='center' width='500' id='tblbtn'>";
              display += "<tr><td align='center' colspan='3'>";
              display +=
                "<span id='addbtn'><a href='#'>ğŸ‘‡ë”ë³´ê¸°</a></span></td>";
              display += "</tr></table>";
            }
            content.innerHTML = display;

            // ë”ë³´ê¸° ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ì²˜ë¦¬
            let addbtn = document.getElementById("addbtn");
            if (addbtn != undefined) {
              addbtn.addEventListener("click", (e) => {
                pageno += 1;
                let request = new XMLHttpRequest();
                request.open("GET", "/item/list?pageno=" + pageno);
                request.send("");

                // ë”ë³´ê¸° ì˜ì—­ì„ ì‚­ì œ
                if (pageno * 5 >= data.count) {
                  pageno -= 1;
                  document.getElementById("tblbtn").remove();
                }

                // ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ë©´
                request.addEventListener("load", () => {
                  let data = JSON.parse(request.responseText);
                  let list = data.list;

                  // ë°ì´í„° í…Œì´ë¸” ì¶œë ¥
                  const table = document.getElementById("tbldata");
                  let display = "";
                  for (item of list) {
                    display += "<tr class='record'>";
                    display += "<td align='center'>" + item.itemid + "</td>";
                    display +=
                      "<td align='left'>" +
                      "<a href='#' id='item" +
                      item.itemid +
                      "'>" +
                      item.itemname +
                      "</a></td>";
                    display += "<td align='right'>" + item.price + "ì›</td>";
                    display += "</tr>";
                  }
                  table.innerHTML += display;
                });
              });
            }
          } else {
            content.innerHTML = "<p>ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨</p>";
          }
        });
      });
      // itemnameì„ ëˆŒë €ì„ ë•Œ ìˆ˜í–‰í•  ì½”ë“œ
      // ë§í¬ í•˜ë‚˜í•˜ë‚˜ì— ì´ë²¤íŠ¸ ì²˜ë¦¬ë¥¼ í•˜ëŠ” ê²ƒì€ ìì› ë‚­ë¹„ì´ë‹¤.
      // ë¶€ëª¨ì— ì´ë²¤íŠ¸ ì²˜ë¦¬ ì½”ë“œë¥¼ ì‘ì„±
      content.addEventListener("click", (e) => {
        // í´ë¦­í•œ ëŒ€ìƒì˜ idê°€ itemìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš°ë§Œ ë™ì‘
        if (e.target.id.startsWith("item")) {
          // í´ë¦­í•œ ëŒ€ìƒì˜ ì•„ì´ë””ì—ì„œ itemì„ ì œì™¸í•œ ë¶€ë¶„ - itemid
          let itemid = e.target.id.substring(4).trim();

          // alert(itemid);
          let request = new XMLHttpRequest();
          request.open("GET", "/item/detail/" + itemid);
          request.send("");
          request.addEventListener("load", () => {
            let data = JSON.parse(request.responseText);
            if (data.result == true) {
              // ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
              let item = data.item;

              // ì¶œë ¥ ë‚´ìš© ìƒì„±
              let display = "<div align='center' class='body'>";
              display += "<h2>ìƒì„¸ë³´ê¸°</h2>";
              display += "<table>";
              display +=
                "<tr><td><a href='/img/" +
                item.pictureurl +
                "'/>" +
                "<img src='/img/" +
                item.pictureurl +
                "'/></td>";

              display += "<td align='center'><table>";
              display += "<tr height='50'><td width='80'>ìƒí’ˆëª…</td>";
              display += "<td width='160'>" + item.itemname + "</td>";
              display += "<tr height='50'><td width='80'>ê°€ê²©</td>";
              display += "<td width='160'>" + item.price + "ì›</td>";
              display += "<tr height='50'><td width='80'>ë¹„ê³ </td>";
              display += "<td width='160'>" + item.description + "</td></tr>";

              // ì‚­ì œë¥¼ ìœ„í•œ DOMì„ ì¶”ê°€
              display +=
                "<tr><td colspan='2' align='center' width='240'" +
                "<a href='#' id='deletebtn'>ë°ì´í„° ì‚­ì œ</a></td></tr>";

              // ìˆ˜ì •ì„ ìœ„í•œ DOM ì¶”ê°€
              display +=
                "<tr><td colspan='2' align='center' width='240'" +
                "<a href='#' id='updatebtn'>ë°ì´í„° ìˆ˜ì •</a></td></tr>";

              display += "</table></td></tr></table>";
              content.innerHTML = display;

              // ë°ì´í„° ìˆ˜ì •ì„ ëˆŒë €ì„ ë•Œ ì²˜ë¦¬
              let updatebtn = document.getElementById("updatebtn");
              if (updatebtn != undefined) {
                updatebtn.addEventListener("click", (e) => {
                  let request = new XMLHttpRequest();
                  request.open("GET", "/item/update");
                  request.send("");
                  request.addEventListener("load", () => {
                    let html = request.responseText;
                    content.innerHTML = html;
                  });
                });
              }

              // ë°ì´í„° ì‚­ì œë¥¼ ëˆŒë €ì„ ë•Œ ì²˜ë¦¬
              let deletebtn = document.getElementById("deletebtn");
              if (deletebtn != undefined) {
                deletebtn.addEventListener("click", (e) => {
                  // í¼ì´ ì—†ëŠ” ê²½ìš°ì˜ POST ë°©ì‹ íŒŒë¼ë¯¸í„° ë§Œë“¤ê¸°
                  let params = "itemid=" + item.itemid;

                  let request = new XMLHttpRequest();
                  request.open("POST", "/item/delete");

                  // í¼ì´ ì•„ë‹Œ ê²½ìš°ëŠ” form í˜•ì‹ìœ¼ë¡œ ì¸ì½”ë”©
                  request.setRequestHeader(
                    "Content-type",
                    "application/x-www-form-urlencoded"
                  );
                  request.send(params);
                  request.addEventListener("load", () => {
                    let data = JSON.parse(request.responseText);
                    if (data.result) {
                      document.getElementById("listbtn").click();
                      alert("ì‚­ì œ ì„±ê³µ");
                    } else {
                      alert("ì‚­ì œ ì‹¤íŒ¨");
                    }
                  });
                });
              }
            }
          });
        }
      });

      let insertbtn = document.getElementById("insertbtn");
      insertbtn.addEventListener("click", (e) => {
        // ì‚½ì…í™”ë©´  ì¶œë ¥
        content.innerHTML = "";
        let html = `
          <div>
            <p></p>
            <form id='insertform'
            enctype='multipart/form-data'
            method='post'>
            ì•„ì´í…œì´ë¦„<input type='text' name='itemname' id='itemname' /><br />
            ê°€ê²©<input type='text' name='price' id='price' /><br />
            ì„¤ëª…<input type='text' name='description' id='description' /><br />
            ì´ë¯¸ì§€<input type='file' name='pictureurl' id='pictureurl' /><br />
            <input type='submit' value='ì‚½ì…' />
            </form></div>
          `;
        content.innerHTML = html;

        // í¼ ì•ˆì—ì„œ ì‚½ì… ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ì²˜ë¦¬
        let f = document.getElementById("insertform");
        if (f != undefined) {
          f.addEventListener("submit", (e) => {
            // ê¸°ë³¸ ì´ë²¤íŠ¸ ì œê±°
            e.preventDefault();

            // í¼ ë°ì´í„°
            const formData = new FormData(
              document.getElementById("insertform")
            );

            // í¼ ë°ì´í„°ë¥¼ ì „ì†¡
            let request = new XMLHttpRequest();
            request.open("POST", "/item/insert", true);
            request.send(formData);
            request.addEventListener("load", () => {
              let data = JSON.parse(request.responseText);
              if (data.result) {
                // ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
                document.getElementById("listbtn").click();
              } else {
                alert("ì‚½ì… ì‹¤íŒ¨");
              }
            });
          });
        }
      });
    });
  </script>
  <body>
    <h1>Maria DB</h1>
    <input type="button" value="ì „ì²´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°" id="allbtn" /><br />
    <input type="button" value="ì¼ë¶€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°" id="listbtn" /><br />
    <input type="button" value="ë°ì´í„° ì‚½ì…" id="insertbtn" /><br />
    <!-- ë°ì´í„° ì¶œë ¥ ì˜ì—­ -->
    <div id="content"></div>
  </body>
</html>
