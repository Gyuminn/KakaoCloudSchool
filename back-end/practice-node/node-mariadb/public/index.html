<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Node - MariaDB</title>
    <link rel="stylesheet" href="./css/common.css" />
  </head>
  <script>
    window.addEventListener("load", (e) => {
      // DOM 찾아오기
      let allbtn = document.getElementById("allbtn");
      let content = document.getElementById("content");

      // allbtn 클릭 이벤트 처리
      allbtn.addEventListener("click", (e) => {
        // ajax로 데이터 가져오기
        let request = new XMLHttpRequest();
        // 뷰랑 서버가 같이 있을 때는 ip 번호와 포트번호는 생략해도 된다.
        // 그렇지만 리액트같은걸로 따로 개발할 때는 모두 써줘야 함. (http://127.0.0.1:9000/item/all)
        // 요청 생성
        request.open("GET", "/item/all");

        // 요청
        request.send("");

        // 데이터가 전송된 경우 처리
        request.addEventListener("load", () => {
          // 출력을 하기 위해서는 JSON 문자열을 자바스크립트 객체로 변환해야 함
          let data = JSON.parse(request.responseText);
          if (data.result == true) {
            let display = "<div align='center' class='body1'>";
            display += "<h2>상품 목록</h2>";
            display += "<table border='1'>";
            display += "<tr class='header'>";
            display += "<th align='center' width='80'>ID</th>";
            display += "<th align='center' width='320'>이름</th>";
            display += "<th align='center' width='100'>가격</th>";

            // list 키에 있는 데이터를 가져오기
            let ar = data.list;

            for (let item of ar) {
              display += "<tr class='record'>";

              display += "<td align='center'>" + item.itemid + "</td>";
              display += "<td align='left'>" + item.itemname + "</td>";
              display += "<td align='right'>" + item.price + "</td>";
              display += "</tr>";
            }
            display += "</tr>";
            display == "</table></div>";
            content.innerHTML = display;
          } else {
            content.innerHTML = "데이터 가져오기 실패";
          }
        });
      });

      let listbtn = document.getElementById("listbtn");
      // 현재 페이지 번호를 저장할 변수를 선언
      let pageno = 1;
      listbtn.addEventListener("click", (e) => {
        let request = new XMLHttpRequest();
        request.open("GET", "/item/list?pageno=" + pageno);
        request.send("");
        request.addEventListener("load", () => {
          // 출력 영역을 초기화
          content.innerHTML = "";
          // 데이터를 파싱
          let data = JSON.parse(request.responseText);
          if (data.result == true) {
            // 데이터 개수와 목록을 가져오기
            let { count, list } = data;

            // 출력 내용 만들기
            let display = "<div align='center' class='body'>";
            display += "<h2>상품 목록</h2>";
            display += "<table border='1' id='tbldata'>";

            // 전체 데이터 개수 출력
            display += "<tr><td colspan='3' align='center'>";
            display += "전체 데이터 개수:" + count + "개</td></tr>";

            // 항목 헤더 출력
            display += "<tr class='header'>";
            display += "<th width='80'>ID</th>";
            display += "<th width='320'>상품명</th>";
            display += "<th width='100'>가격</th>";
            display += "</tr>";

            // 데이터 목록 출력
            for (item of list) {
              display += "<tr class='record'>";
              display += "<td align='center'>" + item.itemid + "</td>";
              display += "<td align='left'>" + item.itemname + "</td>";
              display += "<td align='right'>" + item.price + "원</td>";
              display += "</tr>";
            }

            display == "</table></div>";

            // 더보기 구현
            // 현재 페이지가 마지막 페이지가 아닌 경우만 출력
            if ((pageno - 1) * 5 < count) {
              display += "<table align='center' width='500' id='tblbtn'>";
              display += "<tr><td align='center' colspan='3'>";
              display +=
                "<span id='addbtn'><a href='#'>👇더보기</a></span></td>";
              display += "</tr></table>";
            }
            content.innerHTML = display;

            // 더보기 버튼을 눌렀을 때 처리
            let addbtn = document.getElementById("addbtn");
            if (addbtn != undefined) {
              addbtn.addEventListener("click", (e) => {
                pageno += 1;
                let request = new XMLHttpRequest();
                request.open("GET", "/item/list?pageno=" + pageno);
                request.send("");

                // 더보기 영역을 삭제
                if (pageno * 5 >= data.count) {
                  pageno -= 1;
                  document.getElementById("tblbtn").remove();
                }

                // 데이터를 가져오면
                request.addEventListener("load", () => {
                  let data = JSON.parse(request.responseText);
                  let list = data.list;

                  // 데이터 테이블 출력
                  const table = document.getElementById("tbldata");
                  let display = "";
                  for (item of list) {
                    display += "<tr class='record'>";
                    display += "<td align='center'>" + item.itemid + "</td>";
                    display += "<td align='left'>" + item.itemname + "</td>";
                    display += "<td align='right'>" + item.price + "원</td>";
                    display += "</tr>";
                  }
                  table.innerHTML += display;
                });
              });
            }
          } else {
            content.innerHTML = "<p>데이터를 가져오는데 실패</p>";
          }
        });
      });
    });
  </script>
  <body>
    <h1>Maria DB</h1>
    <input type="button" value="전체 데이터 가져오기" id="allbtn" /><br />
    <input type="button" value="일부 데이터 가져오기" id="listbtn" /><br />
    <!-- 데이터 출력 영역 -->
    <div id="content"></div>
  </body>
</html>
